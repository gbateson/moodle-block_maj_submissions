define(["jquery","jqueryui","core/str","block_maj_submissions/html","block_maj_submissions/unicode"],function($,JUI,STR,HTML,UNICODE){var TOOL={};return TOOL.APPLY_NONE=0,TOOL.APPLY_CURRENT=1,TOOL.APPLY_THISDAY=2,TOOL.APPLY_ALLDAYS=3,TOOL.sourcesession=null,TOOL.sessiontypes="case|lightning|paper|presentation|showcase|workshop",TOOL.sessiontimeroom=".time, .room",TOOL.sessioncontent=".title, .authors, .categorytypetopic, .summary, .scheduleinfo",TOOL.details={roomname:null,roomseats:null,roomtopic:null},TOOL.dialogid="dialog",TOOL.str={},TOOL.init=function(opts){if(opts)for(var i in opts)TOOL[i]=opts[i];TOOL.blockroot=location.href.replace(new RegExp("^(.*?)/tools.*$"),"$1"),TOOL.toolroot=location.href.replace(new RegExp("^(.*?)/tool.php.*$"),"$1"),TOOL.pageid=location.href.replace(new RegExp("^.*?\\bid=([0-9]+)\\b.*$"),"$1"),TOOL.iconroot=$("img.iconhelp").prop("src").replace(new RegExp("/[^/]+$"),""),TOOL.iconedit=TOOL.iconroot+"/i/edit",TOOL.iconremove=TOOL.iconroot+"/i/delete",$("#id_sessioninfo").css("display","none"),$("<link/>",{rel:"stylesheet",type:"text/css",href:TOOL.toolroot+"/styles.css"}).appendTo("head"),$("<link/>",{rel:"stylesheet",type:"text/css",href:TOOL.blockroot+"/templates/template.css"}).appendTo("head"),$.getScript(TOOL.blockroot+"/templates/template.js");var loadstrings=$.Deferred();$.ajax({url:TOOL.toolroot+"/action.php",data:{id:TOOL.pageid,action:"loadstrings"},dataType:"text",method:"GET",success:function(txt){var regexp=new RegExp("MAJ","g");eval(txt.replace(regexp,"TOOL")),loadstrings.resolve()}});var tools=$("<div></div>",{id:"tools"}).insertAfter("#id_sessioninfo"),p={id:TOOL.pageid,action:"loadtools"};tools.load(TOOL.toolroot+"/action.php",p,function(a,b,c){"success"==b?($(this).html(a),TOOL.setup_tools(this)):"error"==b&&$(this).html(TOOL.format_ajax_error(p.action,a,c))});var schedule=$("<div></div>",{id:"schedule"}).insertAfter("#tools"),p={id:TOOL.pageid,action:"loadschedule"};schedule.load(TOOL.toolroot+"/action.php",p,function(a,b,c){"success"==b?($(this).html(a),TOOL.setup_schedule(this,loadstrings)):"error"==b&&$(this).html(TOOL.format_ajax_error(p.action,a,c))});var items=$("<div></div>",{id:"items","class":"schedule"}).insertAfter("#schedule"),p={id:TOOL.pageid,action:"loaditems"};items.load(TOOL.toolroot+"/action.php",p,function(a,b,c){"success"==b?($(this).html(a),TOOL.setup_items(this,loadstrings)):"error"==b&&$(this).html(TOOL.format_ajax_error(p.action,a,c))}),$("form.mform").submit(function(){TOOL.set_schedule_html(),TOOL.set_schedule_unassigned()})},TOOL.setup_tools=function(a){$(a).find(".command").each(function(){var a=!0;$(this).find(".subcommand").each(function(){$(this).click(function(a){var b=$(this).prop("id"),c=b.indexOf("-"),d=b.substring(0,c),e=b.substring(c+1),f=d+"_"+e;TOOL[f]?TOOL[f](a):TOOL[d]&&TOOL[d](a,e)}),a=!1}),a&&$(this).click(function(a){var b=$(this).prop("id");TOOL[b](a)})})},TOOL.setup_schedule=function(a,b){TOOL.clean_emptysessions(a),TOOL.setup_table_rooms(a),TOOL.fix_times_and_rooms(a),TOOL.hide_multilang_spans(a),TOOL.make_sessions_droppable(a),TOOL.make_sessions_draggable(a),TOOL.make_sessions_selectable(a),$.when(b).done(function(){var a=document.querySelector("table.schedule");TOOL.make_sessions_editable(a),TOOL.make_rooms_editable(a),TOOL.make_slots_editable(a),TOOL.make_days_editable(a)})},TOOL.setup_items=function(a,b){TOOL.make_sessions_draggable(a),$.when(b).done(function(){var a=document.getElementById("items");TOOL.make_sessions_selectable(a),TOOL.make_sessions_editable(a)})},TOOL.format_ajax_error=function(a,b,c){var d=!1,e=b.indexOf('<footer id="page-footer"');e>=0&&(b=b.substr(0,e),d=!0);var e=b.indexOf('<div id="page-content"');return e>=0&&(b=b.substr(e),d=!0),d?(b=b.replace(new RegExp("<form[^>]*>.*?</form>","g"),""),b=b.replace(new RegExp('<p class="errorcode">.*?</p>'),""),b=b.replace(new RegExp('<div class="continuebutton">.*?</div>'),"")):"Error ("+a+") "+c.status+": "+c.statusText},TOOL.clean_emptysessions=function(a){$(a).find(".emptysession").each(function(){$(this).removeClass(TOOL.get_non_jquery_classes(this)).addClass("session emptysession")})},TOOL.setup_table_rooms=function(a){var b=0;$(a).find("tbody").each(function(){TOOL.setup_tbody_rooms(this),b=Math.max(b,$(this).data("roomcount"))}),$(a).data("roomcount",b)},TOOL.setup_tbody_rooms=function(a){var b=[],c=0;$(a).find("tr").each(function(){var a=0;$(this).find("th, td").each(function(){for(;b[a];)b[a]--,a++;$(this).data("room",a),c=Math.max(c,a);for(var d=$(this).prop("rowspan")||1,e=$(this).prop("colspan")||1;e>0;)b[a]=d-1+(b[a]||0),a++,e--;if($(this).is(":last-child"))for(;a<b.length;)b[a]&&b[a]--,a++})}),$(a).data("roomcount",c)},TOOL.fix_times_and_rooms=function(a){$(a).find(".session").not(".multiroom").each(function(){TOOL.insert_timeroom(this)})},TOOL.hide_multilang_spans=function(a){var b=TOOL.extract_main_language();$(a).find("span.multilang[lang!="+b+"]").css("display","none")},TOOL.make_sessions_droppable=function(a,b){TOOL.get_items(a,b,"td.session").droppable({accept:".session",drop:function(){$(this).removeClass("ui-dropping"),TOOL.click_session(this)},out:function(){$(this).removeClass("ui-dropping")},over:function(){$(this).addClass("ui-dropping")},tolerance:"pointer"})},TOOL.make_sessions_draggable=function(a,b){TOOL.get_items(a,b,".session").draggable({cursor:"move",scroll:!0,stack:".session",start:function(){TOOL.sourcesession=this,$(this).addClass("ui-dragging"),$(this).removeClass("ui-selected"),$(this).data("startposition",{top:$(this).css("top"),left:$(this).css("left")})},stop:function(){$(this).removeClass("ui-dragging");var a=$(this).data("startposition");a&&($(this).addClass("ui-dropping"),$(this).animate({top:a.top,left:a.left},function(){$(this).removeClass("ui-dropping")}))}})},TOOL.make_sessions_selectable=function(a,b){TOOL.get_items(a,b,".session").click(function(){TOOL.click_session(this)})},TOOL.make_sessions_editable=function(a,b){TOOL.get_items(a,b,".session").each(function(){var a=$(this).prop("id");if(0==a.indexOf("id_record")){var b=TOOL.icons("session");$(this).find(".title").prepend(b)}})},TOOL.make_rooms_editable=function(a,b){TOOL.get_items(a,b,".roomheadings").each(function(){$(this).find(".timeheading").each(function(){var a=TOOL.icons("roomheadings");$(this).prepend(a)}),$(this).find(".roomheading").each(function(){var a=TOOL.icons("room");$(this).prepend(a)})})},TOOL.make_slots_editable=function(a,b){TOOL.get_items(a,b,".slot").each(function(){$(this).find(".timeheading").each(function(){var a=TOOL.icons("slot"),b=document.createTextNode(" ");$(this).append(b,a)})})},TOOL.make_days_editable=function(a,b){TOOL.get_items(a,b,".tab").each(function(){TOOL.make_day_editable(this)})},TOOL.make_day_editable=function(a){var b=TOOL.icons("day"),c=document.createTextNode(" ");$(a).append(c,b)},TOOL.get_items=function(a,b,c){return b?$(b):$(a).find(c)},TOOL.set_schedule_html=function(){var a=TOOL.trim($("#schedule").html());a=a.replace(new RegExp(' *\\bid="yui_[^"]*"',"g"),""),a=a.replace(new RegExp(" *\\bui-[a-z0-9_-]*","g"),""),a=a.replace(new RegExp(' *\\b(display|position|z-index): *[^;"]*;',"g"),""),a=a.replace(new RegExp('(\\b(class|style)=") +',"g"),"$1"),a=a.replace(new RegExp(' *\\b(class|style)=" *"',"g"),""),a=a.replace(new RegExp('(lang="[^"]*") (class="multilang")',"g"),"$2 $1"),a=a.replace(new RegExp(' *\\bxml:\\w+="[^"]*"',"g"),""),a=a.replace(new RegExp('<span\\b[^>]*class="icons"[^>]*>.*?</span>',"g"),""),a=a.replace(new RegExp('<div\\b[^>]*class="schedulechooser"[^>]*>.*?</div>',"g"),""),$("input[name=schedule_html]").val(a)},TOOL.set_schedule_unassigned=function(){var a=[];$("#items .session[id^=id_recordid]").each(function(){a.push($(this).prop("id").substr(12))}),$("input[name=schedule_unassigned]").val(a.join(","))},TOOL.initializeschedule=function(a,b){TOOL.emptyschedule(a,b),$(TOOL.get_day_selector(b)).each(function(){})},TOOL.emptyschedule=function(a,b){$(TOOL.get_day_selector(b," .slot")).each(function(){var a=1;$(this).find(".session").each(function(){TOOL.unassign_session(this),a++,$(this).is(":last-child")&&TOOL.insert_sessions(this,a)})}),$("#items .session").not("div[id^=id_record]").each(function(){$(this).remove()})},TOOL.populateschedule=function(a){var b=TOOL.get_string("populateschedule");b=TOOL.force_single_line(b);var c="";c+="<table><tbody>";var d={selectrooms:"",day:"days",room:"rooms",selectitems:"",category:"categories",type:"types",topic:"topics",time:"times",keyword:"keywords"};for(var e in d){var f=TOOL[d[e]];if(TOOL.empty(f)){var g=HTML.tag("h4",TOOL.str[e]);c+=HTML.starttag("tr",{valign:"top"})+HTML.tag("td",g,{colspan:"3"})+HTML.endtag("tr")}else{var h=f(e,"",{size:3});h&&(c+=HTML.starttag("tr",{valign:"top"})+HTML.tag("th",TOOL.str[e])+HTML.tag("td",h,{colspan:"2"})+HTML.endtag("tr"))}}c+="</tbody></table>";var i=function(){var c=TOOL.form_values(this,"day"),d=TOOL.form_values(this,"room"),e=TOOL.form_values(this,"category"),f=TOOL.form_values(this,"type"),g=TOOL.form_values(this,"topic"),h=TOOL.form_values(this,"time"),i=TOOL.form_values(this,"keyword");if(void 0===c||null===c||""===c)c="";else if("string"==typeof c)c=".date:contains('"+c+"')";else{for(var j=0;j<c.length;j++)c[j]=".date:contains('"+c[j]+"')";c=c.join(", ")}if(void 0===d||null===d||""===d)d="";else if("string"==typeof d)d=".roomname:contains('"+TOOL.extract_roomname_txt(d)+"')";else{for(var j=0;j<d.length;j++)d[j]=".roomname:contains('"+TOOL.extract_roomname_txt(d[j])+"')";d=d.join(", ")}var k=$(".day");if(c&&(k=k.find(c).closest(".day")),k=k.find(".session"),d&&(k=k.find(d).closest(".session")),k=k.filter(function(){return void 0===this.colSpan||null===this.colSpan||0===this.colSpan||1===this.colSpan}).filter(".emptysession:not(.multiroom)"),void 0===e||null===e||""===e)e="";else if("string"==typeof e)e=".category:contains('"+e+"')";else{for(var j=0;j<e.length;j++)e[j]=".category:contains('"+e[j]+"')";e=e.join(", ")}if(void 0===f||null===f||""===f)f="";else if("string"==typeof f)f=".type:contains('"+f+"')";else{for(var j=0;j<f.length;j++)f[j]=".type:contains('"+f[j]+"')";f=f.join(", ")}if(void 0===g||null===g||""===g)g="";else if("string"==typeof g)g=".topic:contains('"+g+"')";else{for(var j=0;j<g.length;j++)g[j]=".topic:contains('"+g[j]+"')";g=g.join(", ")}if(void 0===h||null===h||""===h)h="";else if("string"==typeof h)h=".times .text:contains('"+h+"')";else{for(var j=0;j<h.length;j++)h[j]=".times .text:contains('"+h[j]+"')";h=h.join(", ")}if(void 0===i||null===i||""===i)i="";else if("string"==typeof i)i=".keywords .text:contains('"+i+"')";else{for(var j=0;j<i.length;j++)i[j]=".keywords .text:contains('"+i[j]+"')";i=i.join(", ")}var l=$("#items .session");window.console.log("Start: "+l.length),e&&(l=l.find(e).closest(".session"),window.console.log("Categories: ("+l.length+") "+e)),f&&(l=l.find(f).closest(".session"),window.console.log("Types: ("+l.length+") "+f)),g&&(l=l.find(g).closest(".session"),window.console.log("Topics: ("+l.length+") "+g)),h&&(l=l.find(h).closest(".session"),window.console.log("Times: ("+l.length+") "+h)),i&&(l=l.find(i).closest(".session"),window.console.log("Keywords: ("+l.length+") "+i)),window.console.log("Finish: "+l.length);for(var m=!1,n=Math.min(l.length,k.length),j=n-1;j>=0;j--)TOOL.click_session(l.get(j)),TOOL.click_session(k.get(j)),m=!0;TOOL.redraw_schedule(m),TOOL.open_dialog(a,b,TOOL.get_string("populatedschedule",n),TOOL.str.ok)};TOOL.show_add_dialog(a,b,c,i)},TOOL.populateschedule_old=function(a,b){TOOL.select_session();var c=$(TOOL.get_day_selector(b," .emptysession:not(.multiroom)"));if(0==c.length)return!0;var d=$("#items .session");if(0==d.length)return!0;for(var e=Math.min(d.length,c.length),f=e-1;f>=0;f--)TOOL.click_session(d.get(f)),TOOL.click_session(c.get(f));return!0},TOOL.renumberschedule=function(a,b){var c=[],d={days:$(".day").length,slots:0,rooms:0};$(".day").each(function(){var a=$(this).find(".slot").length;d.slots=Math.max(d.slots,a)}),$(".day").each(function(){$(this).find(".roomheadings").each(function(){var a=$(this).find(".roomheading").length;d.rooms=Math.max(d.rooms,a)})});var e={days:Math.pow(10,Math.ceil(d.days/10)),slots:Math.pow(10,Math.ceil(d.slots/10)),rooms:Math.pow(10,Math.ceil(d.rooms/10))},f=d.days<10&&d.slots<10&&d.rooms<10,g=new RegExp("^.*day(\\d+).*$"),h=new RegExp("^.*slot(\\d+).*$"),i=new RegExp("^.*room(\\d+).*$"),j=new RegExp("^.*("+TOOL.sessiontypes+").*$");$(TOOL.get_day_selector(b," .session:not(.emptysession):not(.demo)")).each(function(){var a=$(this).closest(".day");a=a.prop("class").replace(g,"$1");var b=$(this).prop("class").replace(j,"$1").charAt(0).toUpperCase();if(this.className.indexOf("sharedsession")>=0)var d=this.querySelectorAll(".item");else var d=[this];for(var k=0;k<d.length;k++){if(f){var l=$(this).closest(".slot");l=l.prop("class").replace(h,"$1");var m=$(this).closest(".slot").prevAll(".roomheadings");if(0==m.length||$(this).hasClass("multiroom"))var m=0;else m=m.first().find("th, td").eq(this.cellIndex),m=m.prop("class").replace(i,"$1");var n=a+l+m+"-"+b}else{TOOL.empty(c[a])?c[a]=1:c[a]++;var n=a*e.slots+c[a];n=n+"-"+b}$(d[k]).find(".schedulenumber").text(n)}})},TOOL.get_day_selector=function(a,b){return"."+("alldays"==a?"day":a)+(b?b:"")},TOOL.scheduleinfo_add=function(){TOOL.scheduleinfo_remove();var a={id:TOOL.pageid,action:"loadinfo"};$.getJSON(TOOL.toolroot+"/action.php",a,function(a){TOOL.info=a,TOOL.infoicons={};for(var b in TOOL.info.icons){TOOL.infoicons[b]={};for(var c in TOOL.info[b])for(var d=TOOL.info[b][c].length,e=0;e<d;e++){var f=TOOL.info[b][c][e],g=$("#id_recordid_"+f);if(0!=g.length){var h=TOOL.infoicons[b][c];if(TOOL.empty(h)){var i=0;for(h in TOOL.infoicons[b])i++;h=i>=TOOL.info.icons[b].length?c.charAt(0):TOOL.info.icons[b][i],TOOL.infoicons[b][c]=h}var j=g.find(".scheduleinfo");0==j.length&&(j=HTML.tag("div","",{"class":"scheduleinfo"}),j=$(j).appendTo(g));var k=j.find("."+b);0==k.length&&(k=HTML.tag("div","",{"class":b}),k=$(k).appendTo(j));var l=!1;k.find(".text").each(function(){this.innerHTML==c&&(l=!0)}),0==l&&(l=HTML.tag("span",h,{"class":"icon"})+HTML.tag("span",c,{"class":"text"}),l=HTML.tag("span",l,{"class":"icontext"}),$(l).appendTo(k))}}}})},TOOL.scheduleinfo_remove=function(){$(".scheduleinfo").remove()},TOOL.add_day=function(a){var b=TOOL.str.addday,c=TOOL.position("day",$(".tabs .tab").length),d=TOOL.days("daytext"),e=TOOL.hoursmins("start",9,0),f={},g={},h={},i={},j=new RegExp("(\\d+)\\s*:\\s*(\\d+)\\s*-\\s*(\\d+)\\s*:\\s*(\\d+)");$("tbody.day").each(function(){TOOL.increment(g,$(this).find(".slot").length),$(this).find(".roomheadings").each(function(){TOOL.increment(f,$(this).find(".roomheading").length)}),$(this).find(".timeheading .duration").each(function(){TOOL.increment(h,TOOL.extract_duration($(this).prop("class")))});var a=null;$(this).find(".timeheading .startfinish").each(function(){var b=$(this).text().match(j);if(b&&b.length>4){if("number"==typeof a){var c=60*parseInt(b[1])+parseInt(b[2]);TOOL.increment(i,Math.abs(c-a))}a=60*parseInt(b[3])+parseInt(b[4])}})});var k=TOOL.mode(f)||5,l=TOOL.mode(g)||10,m=TOOL.mode(h)||25,n=TOOL.mode(i)||5;k=TOOL.range("roomcount",k,1,Math.max(10,TOOL.max(f))),l=TOOL.range("slotcount",l,1,Math.max(20,TOOL.max(g))),m=TOOL.mins("slotlength",m,10,Math.max(120,TOOL.max(h))),n=TOOL.mins("slotinterval",n,0,Math.max(60,TOOL.max(i)));var o="";o+="<table><tbody>",o+="<tr>"+HTML.tag("th",TOOL.str.position)+HTML.tag("td",c)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.daytext)+HTML.tag("td",d)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.roomcount)+HTML.tag("td",k)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.slotcount)+HTML.tag("td",l)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.slotstart)+HTML.tag("td",e)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.slotlength)+HTML.tag("td",m)+"</tr>",o+="<tr>"+HTML.tag("th",TOOL.str.slotinterval)+HTML.tag("td",n)+"</tr>",o+="</tbody></table>";var p=function(){var c=TOOL.form_value(this,"position",!0),d=TOOL.form_value(this,"daytext"),e=TOOL.form_value(this,"roomcount",!0),f=TOOL.form_value(this,"slotcount",!0),g=TOOL.form_value(this,"starthours",!0),h=TOOL.form_value(this,"startmins",!0),i=TOOL.form_value(this,"slotlength",!0),j=TOOL.form_value(this,"slotinterval",!0),k=60*parseInt(g)+parseInt(h),l=1,m=!1,n=new RegExp("\\bday\\d+");$("table.schedule").each(function(){$(this).find("tbody.day").each(function(a){0==m&&c<=a&&(m=!0,$(this).before(TOOL.day(l++,d,e,f,k,i,j)));var b=$(this).prop("class").replace(n,"");$(this).prop("class",TOOL.trim(b)+" day"+l++)}),0==m&&(m=!0,$(this).append(TOOL.day(l++,d,e,f,k,i,j)))}),TOOL.renumberslots(c),TOOL.set_schedule_colspan(),TOOL.redraw_schedule(!0),TOOL.open_dialog(a,b,TOOL.str.addedday,TOOL.str.ok)};TOOL.show_add_dialog(a,b,o,p)},TOOL.edit_day=function(a){var b=TOOL.extract_parent_tabday(this),c=$(this).closest(".tab");c.addClass("ui-selected");var d=TOOL.str.editday+TOOL.str.labelsep+b,e="";e+="<table><tbody>";var f="daytext",g=c.find("span.multilang");if(0==g.length){var h=c.contents().filter(TOOL.textnodes).text();e+="<tr>"+HTML.tag("th",TOOL.str[f])+HTML.tag("td",HTML.text(f,TOOL.trim(h)))+"</tr>"}else e+="<tr>"+HTML.tag("td","")+TOOL.boldcenter("td",TOOL.str[f])+"</tr>",g.each(function(){var a=$(this).prop("lang");a&&(e+="<tr>"+HTML.tag("th",TOOL.str[a]?TOOL.str[a]:a)+HTML.tag("td",HTML.text(f+"_"+a,TOOL.trim($(this).html())))+"</tr>")});e+="</tbody></table>",e+=HTML.hidden("day",b);var i=function(){var b=TOOL.multilangs(this,"daytext"),c=TOOL.form_value(this,"day",!0);$(".tab.day"+c).each(function(){$(this).contents().not(".icons").remove(),$(this).prepend(b)}),$(".day.day"+c+" .date td:first-child").each(function(){$(this).contents().remove(),$(this).prepend(TOOL.force_single_line(b))}),$(".subcommand[id$=day"+c+"]").html(b),TOOL.open_dialog(a,d,TOOL.str.editedday,TOOL.str.ok)};TOOL.show_edit_dialog(a,d,e,i)},TOOL.remove_day=function(a){var b=TOOL.extract_parent_tabday(this),c=$(this).closest(".tab");c.addClass("ui-selected");var d=TOOL.extract_main_language(),e=c.find(".multilang[lang="+d+"]").html();if(TOOL.empty(e)){var f=new RegExp("\\s*<span[^>]*>.*?</span>","g");e=c.html().replace(f,"")}e=TOOL.force_single_line(e);var g=TOOL.str.removeday+TOOL.str.labelsep+b,h=HTML.tag("p",TOOL.str.confirmday);h+=HTML.alist("ul",[e]),h+=HTML.hidden("targetday",b);var i=function(){var b=TOOL.form_value(this,"targetday",!0),c=1,d=!1,e=new RegExp("day\\d+");$(".tab[class*=day]").each(function(){var a=$(this).prop("class"),f=TOOL.extract_day(a);f==b?($(this).hasClass("active")&&(d=!0),$(this).remove()):(a=TOOL.trim(a.replace(e,"")),$(this).prop("class",a+" day"+c++))}),$(".day.day"+b).each(function(){$(this).find(".session").each(function(){TOOL.unassign_session(this,!0)})}),d&&$(".tab").first().trigger("click"),TOOL.set_schedule_colspan(),$(".subcommand[id$=day"+b+"]").remove(),TOOL.open_dialog(a,g,TOOL.str.removedday,TOOL.str.ok)};TOOL.show_remove_dialog(a,g,h,i)},TOOL.increment=function(a,b){TOOL.empty(a[b])?a[b]=1:a[b]++},TOOL.mode=function(a){var b=null,c=null;for(var d in a)d=parseInt(d),(TOOL.empty(c)||c<a[d]||c==a[d]&&b<d)&&(c=a[d],b=d);return TOOL.empty(b)?0:b},TOOL.max=function(a){var b=null;for(var c in a)c=parseInt(c),(TOOL.empty(b)||b<c)&&(b=c);return TOOL.empty(b)?0:b},TOOL.add_roomheadings=function(a){var b=TOOL.str.addroomheadings,c="";c+="<table><tbody>",c+=TOOL.days_checkbox("days");for(var d=TOOL.extract_max_roomcount(),e=1;e<=d;e++)1==e&&(c+=TOOL.html_roomheadings_toprow()),c+=TOOL.html_roomheadings_datarow(null,e);c+="</tbody></table>";var f=function(){var c=TOOL.form_values(this,"days_",!0),d=TOOL.form_values(this,"room_"),e=TOOL.form_values(this,"topic_"),f=!1;$(".day").each(function(){var a=TOOL.extract_day($(this).prop("class"));if(c[a]){var b=!0;$(this).find("tr").not(".date").each(function(){TOOL.has_multiroom($(this))?b=!0:b&&($(this).is(":not(.roomheadings)")&&(TOOL.roomheadings(a,d,e).insertBefore(this),f=!0),b=!1)})}}),TOOL.redraw_schedule(f),TOOL.open_dialog(a,b,TOOL.str.addedroomheadings,TOOL.str.ok)};TOOL.show_add_dialog(a,b,c,f)},TOOL.edit_roomheadings=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_row(this),d=TOOL.str.editroomheadings,e="";e+="<table><tbody>";var f=1;$(this).closest("th").nextAll(".roomheading").each(function(){1==f&&(e+=TOOL.html_roomheadings_toprow()),e+=TOOL.html_roomheadings_datarow(this,f++)}),f>1&&(e+=TOOL.html_roomheadings_lastrow()),e+="</tbody></table>",e+=HTML.hidden("day",b),e+=HTML.hidden("row",c);var g=!1,h=function(){var b=TOOL.form_value(this,"day",!0),c=TOOL.form_value(this,"row",!0),e=TOOL.form_values(this,"room_"),f=TOOL.form_values(this,"topic_"),h=TOOL.form_value(this,"applyto");$("tbody.day").each(function(){var a=TOOL.extract_day($(this).prop("class"));if(h==TOOL.APPLY_CURRENT||h==TOOL.APPLY_THISDAY)var d=a==b;else var d=h==TOOL.APPLY_ALLDAYS;d&&$(this).find(".roomheadings").each(function(){d=h!=TOOL.APPLY_CURRENT||c==TOOL.extract_parent_row(this),d&&($(this).replaceWith($(TOOL.html_roomheadings(b,e,f)).each(function(){TOOL.make_rooms_editable(null,this)})),g=!0)})}),TOOL.redraw_schedule(g),TOOL.open_dialog(a,d,TOOL.str.editedroomheadings,TOOL.str.ok)};TOOL.show_edit_dialog(a,d,e,h)},TOOL.remove_roomheadings=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_row(this),d=TOOL.extract_parent_daytext(this),e=TOOL.str.removeroomheadings,f=HTML.tag("p",TOOL.str.confirmroomheadings);f+=HTML.alist("ul",[d]),f+=HTML.hidden("day",b),f+=HTML.hidden("row",c);var g=function(){var b=TOOL.form_value(this,"day",!0),c=TOOL.form_value(this,"row",!0);$(".day.day"+b).closest("table").find("tr:eq("+c+")").remove(),TOOL.open_dialog(a,e,TOOL.str.removedroomheadings,TOOL.str.ok)};TOOL.show_remove_dialog(a,e,f,g)},TOOL.add_room=function(a){var b=TOOL.str.addroom,c="";c+="<table><tbody>",c+=TOOL.days_checkbox("days");var d=TOOL.position("room",TOOL.extract_max_roomcount());c+="<tr>"+HTML.tag("th",TOOL.str.position)+HTML.tag("td",d)+"</tr>",c+="<tr>"+HTML.tag("th",TOOL.str.roomname)+HTML.tag("td",TOOL.rooms("roomtxt"))+"</tr>",c+="<tr>"+HTML.tag("th",TOOL.str.roomtopic)+HTML.tag("td",HTML.text("roomtopic"))+"</tr>",c+="</tbody></table>";var e=function(){var c=TOOL.form_values(this,"days_",!0),d=TOOL.form_value(this,"roomtxt"),e=TOOL.form_value(this,"roomtopic"),f=TOOL.form_value(this,"position",!0),g=!1;$(".day").each(function(){var a=TOOL.extract_day($(this).prop("class"));if(c[a]){$(this).find(".date td").each(function(){var a=$(this).prop("colspan")||1;$(this).prop("colspan",a+1)}),$(this).find(".roomheadings").each(function(){var a=0,b=!1,c=new RegExp("\\broom\\d+");$(this).find(".roomheading").each(function(){var a=$(this).data("room");0==b&&f<=a&&(b=!0,$(this).before(TOOL.roomheading(a,d,e))),b&&a++;var g=$(this).prop("class").replace(c,"");$(this).prop("class",TOOL.trim(g)+" room"+a)}),0==b&&(b=!0,a++,$(this).append(TOOL.roomheading(a,d,e)))});var b=HTML.tag("td","",{"class":"session emptysession"});$(this).find(".slot").each(function(){var a=!1;$(this).find(".session").each(function(){var c=$(this).data("room");0==a&&(this.colSpan&&this.colSpan>1?($(this).prop("colspan",this.colSpan+1),a=!0):f<=c&&(TOOL.insert_session(b,"insertBefore",this),a=!0))}),0==a&&(a=!0,TOOL.insert_session(b,"appendTo",this))})}}),TOOL.set_schedule_colspan(),TOOL.redraw_schedule(g),TOOL.open_dialog(a,b,TOOL.str.addedroom,TOOL.str.ok)};TOOL.show_add_dialog(a,b,c,e)},TOOL.edit_room=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_room(this),d=[],e={},f=$(this).closest(".roomheading");f.addClass("ui-selected");for(var g in TOOL.details){var h=f.find("."+g);if(0!=h.length){e[g]={};var i=h.find("span.multilang");0!=i.length?i.each(function(){var a=$(this).prop("lang");a&&(d.indexOf(a)<0&&d.push(a),e[g][a]=$(this).text())}):e[g]=h.text()}}var j=TOOL.str.editroom+TOOL.str.labelsep+c,k="";if(k+="<table><tbody>",d.length){k+="<tr>"+HTML.tag("td","");for(var l=0;l<d.length;l++){var m=d[l],n=TOOL.str[m]?TOOL.str[m]:m;k+=TOOL.boldcenter("td",n)}k+="</tr>"}for(var g in e){if(k+="<tr>"+HTML.tag("th",TOOL.str[g]),0==d.length){var o=TOOL.trim(e[g]);k+=HTML.tag("td",HTML.text(g,o,12))}else for(var l=0;l<d.length;l++){var m=d[l],o="";"string"==typeof e[g]?o=TOOL.trim(e[g]):e[g][m]&&(o=TOOL.trim(e[g][m])),k+=HTML.tag("td",HTML.text(g+"_"+m,o))}k+="</tr>"}k+="</tbody></table>",k+=HTML.hidden("day",b),k+=HTML.hidden("room",c);var p=function(){var b=TOOL.form_value(this,"day",!0),c=TOOL.form_value(this,"room",!0),d=$(".day"+b+" .roomheading.room"+c),e=$(".day"+b+" .session .room"+c);for(var f in TOOL.details){var g=TOOL.multilangs(this,f);d.find("."+f).html(g),e.find("."+f).html(g)}TOOL.open_dialog(a,j,TOOL.str.editedroom,TOOL.str.ok)};TOOL.show_edit_dialog(a,j,k,p)},TOOL.remove_room=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_room(this),d=TOOL.extract_parent_daytext(this),e=$(this).closest(".roomheading");e.addClass("ui-selected");var f=TOOL.str.removeroom+TOOL.str.labelsep+c,g=HTML.tag("p",TOOL.str.confirmroom);g+="<table><tbody>",g+="<tr>"+HTML.tag("th",TOOL.str.day)+HTML.tag("td",d)+"</tr>";for(var h in TOOL.details){var i=e.find("."+h);i.html()&&(g+="<tr>"+HTML.tag("th",TOOL.str[h])+HTML.tag("td",i.html())+"</tr>")}g+="</tbody></table>",g+=HTML.hidden("day",b),g+=HTML.hidden("room",c);var j=function(){var b=TOOL.form_value(this,"day",!0),c=TOOL.form_value(this,"room",!0),d=".day"+b+" .date td",e=".day"+b+" .slot",g=".day"+b+" .roomheading.room"+c,h=$(g).index();$(g).remove();var i=0;$(e).each(function(){var a=0,b=!1;$(this).find("th, td").each(function(){if(b)return a++,!0;if(this.colSpan&&this.colSpan>1){var c=this.colSpan-1;return 1==c?$(this).removeAttr("colspan"):$(this).prop("colspan",c),a+=c,b=!0,!0}return $(this).index()==h?(TOOL.unassign_session(this,!0),b=!0,!0):void a++}),i=Math.max(i,a)}),i>1?$(d).prop("colspan",i):$(d).removeAttr("colspan"),TOOL.set_schedule_colspan(),TOOL.open_dialog(a,f,TOOL.str.removedroom,TOOL.str.ok)};TOOL.show_remove_dialog(a,f,g,j)},TOOL.add_slot=function(a){var b=TOOL.str.addslot,c=TOOL.hoursmins("start"),d=TOOL.hoursmins("finish"),e=TOOL.days_select("targetday"),f="";f+="<table><tbody>",f+="<tr>"+HTML.tag("th",TOOL.str.day)+HTML.tag("td",e)+"</tr>",f+="<tr>"+HTML.tag("th",TOOL.str.starttime)+HTML.tag("td",c)+"</tr>",f+="<tr>"+HTML.tag("th",TOOL.str.finishtime)+HTML.tag("td",d)+"</tr>",f+="</tbody></table>";var g=function(){var c=TOOL.form_value(this,"targetday",!0),d=TOOL.form_value(this,"starthours",!0),e=TOOL.form_value(this,"startmins",!0),f=TOOL.form_value(this,"finishhours",!0),g=TOOL.form_value(this,"finishmins",!0),h=TOOL.form_duration(d,e,f,g),i=TOOL.form_startfinish(d,e,f,g),j=TOOL.slot(c,i,h);$(".day.day"+c).find(".slot").each(function(){var a=$(this).find(".timeheading .startfinish").text();return a>i&&(j.insertBefore(this),j=null),!TOOL.empty(j)}),j&&($(".day.day"+c).append(j),j=null),TOOL.redraw_schedule(!0),TOOL.renumberslots(c),TOOL.open_dialog(a,b,TOOL.str.addedslot,TOOL.str.ok)};TOOL.show_add_dialog(a,b,f,g)},TOOL.edit_slot=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_slot(this),d=TOOL.extract_parent_daytext(this),e=$(this).closest(".timeheading");e.addClass("ui-selected");var f=e.find(".startfinish").text(),g=new RegExp("^.*(\\d{2}).*(\\d{2}).*(\\d{2}).*(\\d{2}).*$"),h=parseInt(f.replace(g,"$1")),i=parseInt(f.replace(g,"$2")),j=parseInt(f.replace(g,"$3")),k=parseInt(f.replace(g,"$4")),l=".day"+b+" .slot"+c,m=$(l),n=TOOL.str.editslot,o=TOOL.hoursmins("start",h,i),p=TOOL.hoursmins("finish",j,k),q=HTML.checkbox("multiroom",TOOL.has_multiroom(m))+" "+TOOL.rooms("roomtxt",r),r=TOOL.extract_sessionroom(l+" .multiroom","name"),s="";s+="<table><tbody>",s+="<tr>"+HTML.tag("th",TOOL.str.day)+HTML.tag("td",d)+"</tr>",s+="<tr>"+HTML.tag("th",TOOL.str.starttime)+HTML.tag("td",o)+"</tr>",s+="<tr>"+HTML.tag("th",TOOL.str.finishtime)+HTML.tag("td",p)+"</tr>",s+="<tr>"+HTML.tag("th",TOOL.str.largeroom)+HTML.tag("td",q)+"</tr>",s+="</tbody></table>",s+=HTML.hidden("day",b),s+=HTML.hidden("slot",c);var t=function(){var b=TOOL.form_value(this,"day",!0),c=TOOL.form_value(this,"roomtxt"),d=TOOL.form_value(this,"multiroom",!0),e=TOOL.form_value(this,"starthours",!0),f=TOOL.form_value(this,"startmins",!0),g=TOOL.form_value(this,"finishhours",!0),h=TOOL.form_value(this,"finishmins",!0),i=TOOL.form_duration(e,f,g,h),j=TOOL.form_startfinish(e,f,g,h);$(l+" .startfinish").html(j),$(l+" .duration").html(TOOL.get_string("durationtxt",i));var k=new RegExp("\\bduration\\w+"),m=$(l).prop("class").replace(k,"");$(l).prop("class",m+" duration"+i);var o=1,p=!0,q=TOOL.extract_roomcount(b);$(l+" .session").each(function(){d?p?(p=!1,$(this).addClass("multiroom"),q>1&&$(this).prop("colspan",q),TOOL.insert_timeroom(this,c)):TOOL.unassign_session(this,!0):($(this).is(".multiroom")&&$(this).removeClass("multiroom"),this.colSpan&&$(this).removeAttr("colspan"),$(this).is(":not(.emptysession)")?TOOL.insert_timeroom(this):$(this).find(TOOL.sessiontimeroom).remove(),o++,$(this).is(":last-child")&&TOOL.insert_sessions(this,o,b))}),TOOL.open_dialog(a,n,TOOL.str.editedslot,TOOL.str.ok)};TOOL.show_edit_dialog(a,n,s,t)},TOOL.remove_slot=function(a){var b=TOOL.extract_parent_day(this),c=TOOL.extract_parent_slot(this),d=TOOL.extract_parent_daytext(this),e=".day"+b+" .slot"+c,f=$(e+" .timeheading");f.addClass("ui-selected");var g=f.find(".startfinish").text(),h=f.find(" .duration").html(),i=TOOL.str.removeslot+TOOL.str.labelsep+c,j=HTML.tag("p",TOOL.str.confirmslot);j+="<table><tbody>",j+="<tr>"+HTML.tag("th",TOOL.str.day)+HTML.tag("td",d)+"</tr>",j+="<tr>"+HTML.tag("th",TOOL.str.time)+HTML.tag("td",g)+"</tr>",j+="<tr>"+HTML.tag("th",TOOL.str.duration)+HTML.tag("td",h)+"</tr>",j+="</tbody></table>",j+=HTML.hidden("day",b),j+=HTML.hidden("slot",c);var k=function(){var b=TOOL.form_value(this,"day",!0);$(e+" .session").each(function(){TOOL.unassign_session(this,!0)}),$(e).remove(),TOOL.renumberslots(b),TOOL.open_dialog(a,i,TOOL.str.removedslot,TOOL.str.ok)};TOOL.show_remove_dialog(a,i,j,k)},TOOL.redraw_schedule=function(a){a&&$("#schedule").hide().show(50)},TOOL.set_schedule_colspan=function(a){TOOL.empty(a)&&(a=TOOL.extract_max_roomcount()+1),$(".scheduletitle, .tabs").find("td").prop("colspan",a)},TOOL.renumberslots=function(a){var b=0;$(".day.day"+a).find(".slot").each(function(){$(this).prop("class","slot slot"+b++)})},TOOL.edit_session=function(a){var b=$(this).closest(".session"),c=HTML.text("title",b.find(".title").text(),50),d=HTML.text("authornames",b.find(".authornames").html(),50),e=HTML.text("schedulenumber",b.find(".schedulenumber").text(),5),f=TOOL.categories("category",b.find(".category").html()),g=TOOL.types("type",b.find(".type").html()),h=TOOL.topics("topic",b.find(".topic").html()),i=TOOL.range("rowspan",b.prop("rowspan")),j=TOOL.range("colspan",b.prop("colspan")),k=HTML.hidden("id",b.prop("id")),l="";l+="<table><tbody>",l+="<tr>"+HTML.tag("th",TOOL.str.title)+HTML.tag("td",c)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.authornames)+HTML.tag("td",d)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.schedulenumber)+HTML.tag("td",e)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.category)+HTML.tag("td",f)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.type)+HTML.tag("td",g)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.topic)+HTML.tag("td",h)+"</tr>",b.parent().hasClass("slot")&&(l+="<tr>"+HTML.tag("th",TOOL.str.rowspan)+HTML.tag("td",i)+"</tr>",l+="<tr>"+HTML.tag("th",TOOL.str.colspan)+HTML.tag("td",j)+"</tr>"),l+="</tbody></table>",l+=k;var m=function(){var b=TOOL.form_value(this,"id"),c=TOOL.form_value(this,"title"),d=TOOL.form_value(this,"authornames"),e=TOOL.form_value(this,"schedulenumber"),f=TOOL.form_value(this,"category"),g=TOOL.form_value(this,"type"),h=TOOL.form_value(this,"topic"),i=TOOL.form_value(this,"rowspan",!0),j=TOOL.form_value(this,"colspan",!0),k=$("#"+b);k.find(".title").contents().filter(TOOL.textnodes).remove(),k.find(".title").append(c),k.find(".authornames").html(d),k.find(".schedulenumber").text(e),k.find(".category").html(f),k.find(".type").html(g),k.find(".topic").html(h),TOOL.change_rowspan_colspan(k,i,j),
TOOL.open_dialog(a,TOOL.str.editsession,TOOL.str.editedsession,TOOL.str.ok)};TOOL.select_session(k),TOOL.show_edit_dialog(a,TOOL.str.editsession,l,m)},TOOL.remove_session=function(a){var b=$(this).closest(".session").prop("id"),c=TOOL.extract_recordid(b),d=TOOL.str.removesession+": rid="+c,e=HTML.tag("p",TOOL.str.confirmsession),f=function(){var c=TOOL.item(null,"session emptysession").appendTo("#items");TOOL.select_session(),TOOL.click_session(c),TOOL.click_session(document.getElementById(b),!0),TOOL.open_dialog(a,d,TOOL.str.removedsession,TOOL.str.ok)};TOOL.select_session(b),TOOL.show_remove_dialog(a,d,e,f)},TOOL.select_session=function(a){TOOL.sourcesession?TOOL.click_session(TOOL.sourcesession):$(".ui-selected").removeClass("ui-selected"),a&&TOOL.click_session(document.getElementById(a))},TOOL.click_session=function(a,b){if(TOOL.empty(TOOL.sourcesession))return TOOL.sourcesession=a,$(a).addClass("ui-selected"),!0;var c=$(a).hasClass("emptysession"),d=$(TOOL.sourcesession).hasClass("emptysession");if(TOOL.sourcesession==a||d&&c)return $(TOOL.sourcesession).removeClass("ui-selected"),$(a).removeClass("ui-selected"),TOOL.sourcesession=null,!0;var e=$(a).hasClass("multiroom"),f=$(TOOL.sourcesession).hasClass("multiroom"),g=$(a).closest("table.schedule").length,h=$(TOOL.sourcesession).closest("table.schedule").length,i=!!b;if(0==c&&0==d&&(i=!0),a.tagName==TOOL.sourcesession.tagName&&(i=!0),i){$(a).addClass("ui-selected");var j=document.createElement("DIV"),k=document.createElement("DIV"),l=$(TOOL.sourcesession).prop("id"),m=$(a).prop("id");$(TOOL.sourcesession).prop("id",m),$(a).prop("id",l);var n=TOOL.get_non_jquery_classes(TOOL.sourcesession),o=TOOL.get_non_jquery_classes(a);return $(TOOL.sourcesession).removeClass(n).addClass(o),$(a).removeClass(o).addClass(n),h&&(c&&0==f?$(TOOL.sourcesession).children(TOOL.sessiontimeroom).remove():$(TOOL.sourcesession).children(TOOL.sessiontimeroom).appendTo(k)),0==c&&$(a).children(TOOL.sessioncontent).appendTo(k),g&&(d&&0==e?$(a).children(TOOL.sessiontimeroom).remove():$(a).children(TOOL.sessiontimeroom).appendTo(j)),0==d&&$(TOOL.sourcesession).children(TOOL.sessioncontent).appendTo(j),$(j).children().appendTo(a),$(k).children().appendTo(TOOL.sourcesession),h&&(f?$(TOOL.sourcesession).addClass("multiroom"):($(TOOL.sourcesession).removeClass("multiroom"),0==c&&TOOL.insert_timeroom(TOOL.sourcesession))),g&&(e?$(a).addClass("multiroom"):($(a).removeClass("multiroom"),0==c&&TOOL.insert_timeroom(a))),k=null,j=null,$(TOOL.sourcesession).removeClass("ui-selected"),TOOL.sourcesession=null,$(a).removeClass("ui-selected"),!0}var p=null,q=null;if(d&&0==c&&(p=TOOL.sourcesession,q=a),0==d&&c&&(p=a,q=TOOL.sourcesession),p&&q){$(p).addClass("ui-selected"),$(p).prop("id",$(q).prop("id"));var r=$(p).is(".multiroom"),s=TOOL.get_non_jquery_classes(p),t=TOOL.get_non_jquery_classes(q);return $(p).removeClass(s).addClass(t),r?($(p).addClass("multiroom"),$(p).children().not(TOOL.sessiontimeroom).remove()):($(p).removeClass("multiroom"),$(p).children().remove(),TOOL.insert_timeroom(p)),$(q).children(TOOL.sessioncontent).appendTo(p),$(p).removeClass("ui-selected"),$(q).remove(),TOOL.sourcesession=null,!0}},TOOL.show_add_dialog=function(a,b,c,d){TOOL.open_dialog(a,b,c,TOOL.str.add,null,d,!0)},TOOL.show_edit_dialog=function(a,b,c,d){TOOL.open_dialog(a,b,c,TOOL.str.update,null,d,!0)},TOOL.show_remove_dialog=function(a,b,c,d){TOOL.open_dialog(a,b,c,TOOL.str.remove,null,d,!0)},TOOL.open_dialog=function(a,b,c,d,e,f,g){var h=!0,i=document.getElementById(TOOL.dialogid);TOOL.empty(i)&&(i=document.createElement("DIV"),i.setAttribute("id",TOOL.dialogid),$("body").append(i));var j=$(i);TOOL.empty(j.dialog("instance"))?j.dialog({autoOpen:!1,close:TOOL.select_session,width:"auto"}):j.dialog("isOpen")&&j.dialog("close"),j.dialog("option","title",b),j.html(c),j.dialog("option","modal",g);var k=[];if(h&&(TOOL.empty(d)&&(d=TOOL.str.ok),TOOL.empty(e)&&(e="ui-icon-check"),TOOL.empty(f)&&(f=function(){$(this).dialog("close")}),k.push({text:d,click:f})),g){var l=TOOL.str.cancel,m=function(){$(this).dialog("close"),TOOL.select_session()};k.push({text:l,click:m})}j.dialog("option","buttons",k),j.dialog("open"),a.stopPropagation()},TOOL.close_dialog=function(){$("#"+TOOL.dialogid).dialog("close")},TOOL.has_multiroom=function(a){return a.find(".session").filter(TOOL.colspan).length>0},TOOL.extract_main_language=function(){var a=new RegExp("lang-(\\w+)");return $("body").attr("class").match(a)[1]},TOOL.extract_parent_daytext=function(a){var b=$(a).closest(".day").find(".date td");return 0==b.length?"":TOOL.force_single_line(b.first().html())},TOOL.extract_parent_row=function(a){return $(a).closest("tr").prop("rowIndex")},TOOL.extract_parent_day=function(a){return TOOL.extract_parent_number(a,"day","day")},TOOL.extract_parent_tabday=function(a){return TOOL.extract_parent_number(a,"tab","day")},TOOL.extract_parent_room=function(a){return TOOL.extract_parent_number(a,"roomheading","room")},TOOL.extract_parent_slot=function(a){return TOOL.extract_parent_number(a,"slot","slot")},TOOL.extract_parent_number=function(a,b,c){var d=$(a).closest("."+b).prop("class");return TOOL.extract_type_number(d,c)},TOOL.extract_recordid=function(a){return TOOL.extract_number(a,"id_recordid_","")},TOOL.extract_active_day=function(){return TOOL.extract_day($(".tab.active").prop("class"))},TOOL.extract_day=function(a){return TOOL.extract_type_number(a,"day")},TOOL.extract_room=function(a){return TOOL.extract_type_number(a,"room")},TOOL.extract_slot=function(a){return TOOL.extract_type_number(a,"slot")},TOOL.extract_duration=function(a){return TOOL.extract_number(a,".*\\bduration","\\b.*")},TOOL.extract_type_number=function(a,b){return TOOL.extract_number(a,".*\\b"+b,"\\b.*")},TOOL.extract_number=function(a,b,c){if("string"==typeof a){var d="^"+b+"(\\d+)"+c+"$",e=a.replace(new RegExp(d),"$1");return isNaN(e)?0:parseInt(e)}return 0},TOOL.extract_roomcount=function(a){return $(".day.day"+a).data("roomcount")},TOOL.extract_max_roomcount=function(a){var b=0,c=".day";return a&&(c+=".day"+a),$(c).each(function(){var a=TOOL.extract_parent_day(this);b=Math.max(b,TOOL.extract_roomcount(a))}),b},TOOL.extract_roomname_txt=function(a){return TOOL.extract_room_txt(a)},TOOL.extract_roomseats_txt=function(a){return TOOL.extract_room_txt(a,!0)},TOOL.extract_room_txt=function(a,b){if(a==TOOL.trim(a)){if(a.indexOf('class="multilang"')<0)var c=new RegExp("^(.*)\\((.*?)\\)(.*?)$"),d=new RegExp("^(.*)（(.*?)）(.*?)$"),e=b?"$2":"$1$3";else var c=new RegExp("(<span[^>]*>)([^<]*?)\\((.*?)\\)(.*?)(</span>)"),d=new RegExp("(<span[^>]*>)([^<]*?)（(.*?)）(.*?)(</span>)"),e=b?"$1$3$5":"$1$2$4$5";a=a.replace(c,e).replace(d,e)}return a},TOOL.extract_startfinish_html=function(a,b){return TOOL.extract_time_html(a,b,"startfinish")},TOOL.extract_duration_html=function(a,b){return TOOL.extract_time_html(a,b,"duration")},TOOL.extract_time_html=function(a,b,c){return $(".day.day"+a+" .slot"+b+" .timeheading ."+c).html()},TOOL.extract_roomname_html=function(a,b){return TOOL.extract_room_html(a,b,"roomname")},TOOL.extract_roomseats_html=function(a,b){return TOOL.extract_room_html(a,b,"roomseats")},TOOL.extract_roomtopic_html=function(a,b){return TOOL.extract_room_html(a,b,"roomtopic")},TOOL.extract_room_html=function(a,b,c){return $(".day.day"+a+" .roomheadings .room"+b+" ."+c).html()},TOOL.extract_sessionroom=function(a,b){var c=[];h?c.push(h):c.push("name","seats","topic");var d={},e=TOOL.extract_main_language();for(var f in c){var g="",h=c[f],i="extract_room"+h+"_txt";if(a){var j=$(a).find(".room"+h);j.length&&(j.find("span.multilang").length&&(j=j.find("span.multilang"),j.find("[lang="+e+"]").length&&(j=j.find("[lang="+e+"]"))),g=j.first().html(),TOOL[i]&&(g=TOOL[i](g)))}d[h]=g}return b?d[b]:d},TOOL.colspan=function(){return this.colSpan&&this.colSpan>1},TOOL.textnodes=function(){return this.nodeType&&3===this.nodeType},TOOL.change_rowspan_colspan=function(a,b,c){var d=a.prop("cellIndex"),e=a.prop("rowspan"),f=a.prop("colspan");if(e==b)return!0;if(void 0===f&&(f=0),void 0===c&&(c=0),e<b){var g=0;a.closest("tr").nextAll().each(function(){return g++,g<e||!(g>=b)&&void $(this).find("th, td").eq(d).each(function(){TOOL.unassign_session(this,!0)})})}if(e>b){var g=0;a.closest("tr").nextAll().each(function(){if(g++,g<b)return!0;if(g>=e)return!1;var c=TOOL.html_sessions(d,d);a.is(":last-child")?$(this).append(c):$(this).find("th, td").eq(d).each(function(){TOOL.insert_session(c,"insertBefore",this)})})}a.prop("rowspan",b)},TOOL.unassign_session=function(a,b){var c=$(a).prop("id");0==c.indexOf("id_recordid_")&&($(a).removeAttr("id"),TOOL.item(c,TOOL.get_non_jquery_classes(a)).append($(a).children(TOOL.sessioncontent)).appendTo("#items")),b?$(a).remove():($(a).children().remove(),TOOL.insert_timeroom(a),$(a).removeAttr("id colspan").removeClass("demo attending multiroom").addClass("emptysession"))},TOOL.insert_sessions=function(a,b,c,d){if(TOOL.empty(c)&&(c=TOOL.extract_parent_day(a)),TOOL.empty(d)&&(d=TOOL.extract_roomcount(c)),b<=d){var e=TOOL.html_sessions(b,d);TOOL.insert_session(e,"insertAfter",a)}},TOOL.insert_session=function(a,b,c){$(a).each(function(){TOOL.make_sessions_editable(null,this),TOOL.make_sessions_droppable(null,this),TOOL.make_sessions_draggable(null,this),TOOL.make_sessions_selectable(null,this)})[b](c)},TOOL.insert_timeroom=function(a,b){var c=TOOL.extract_parent_day(a),d=TOOL.extract_parent_slot(a),e=$(a).data("room");TOOL.empty(e)&&(e=$(a).index()),TOOL.insert_time(a,c,d),TOOL.insert_room(a,c,e,b)},TOOL.insert_time=function(a,b,c){var d=TOOL.html_time(b,c);$(a).find(".time").length?$(a).find(".time").replaceWith(d):$(a).prepend(d)},TOOL.insert_room=function(a,b,c,d){var e=TOOL.html_room(b,c,d);$(a).find(".room").length?$(a).find(".room").replaceWith(e):$(a).find(".time").length?$(a).find(".time").after(e):$(a).prepend(e)},TOOL.get_non_jquery_classes=function(a){for(var b=$(a).prop("class").split(new RegExp("\\s+")),c=b.length-1,d=c;d>=0;d--)0==b[d].indexOf("ui-")&&b.splice(d,1);return b.join(" ")},TOOL.day=function(a,b,c,d,e,f,g){var h=TOOL.html_day(a,b,c,d,e,f,g);return $(h).each(function(){TOOL.make_day_editable(this)})},TOOL.roomheadings=function(a,b,c){var d=$(".day.day"+a+" .roomheadings");return d.length?d.first().clone():(d=$(TOOL.html_roomheadings(a,b,c)),TOOL.make_rooms_editable(null,d),d)},TOOL.roomheading=function(a,b,c){var d=TOOL.extract_roomname_txt(b),e=TOOL.extract_roomseats_txt(b),f=$(TOOL.html_roomheading(a,d,e,c));return f.prepend(TOOL.icons("room")),f},TOOL.slot=function(a,b,c){var d=$(TOOL.html_slot(a,b,c));return TOOL.make_slots_editable(null,d),TOOL.make_sessions_droppable(d),TOOL.make_sessions_draggable(d),TOOL.make_sessions_selectable(d),d},TOOL.item=function(a,b){var c=$(TOOL.html_item(a,b));return TOOL.make_sessions_draggable(null,c),TOOL.make_sessions_selectable(null,c),c},TOOL.icons=function(a,b){var c=document.createElement("SPAN");c.setAttribute("class","icons"),TOOL.empty(b)?b=["edit","remove"]:"string"==typeof b&&(b=[b]);for(var d in b){var e=b[d],f=e+"_"+a,g=document.createElement("IMG");g.setAttribute("src",TOOL["icon"+e]),g.setAttribute("title",TOOL.str[e+a]),g.setAttribute("class","icon"),g.setAttribute("clickhandler",f),TOOL[f]?$(g).click(TOOL[f]):$(g).click(TOOL.noclickhandler),c.appendChild(g)}return c},TOOL.noclickhandler=function(){alert("Oops, click handler is missing: TOOL."+this.getAttribute("clickhandler")+"()")},TOOL.html_day=function(a,b,c,d,e,f,g){var h="";h+=HTML.starttag("tbody",{"class":"day day"+a}),h+=HTML.starttag("tr",{"class":"date"}),h+=HTML.tag("td",b,{colspan:c}),h+=HTML.endtag("tr"),h+=TOOL.html_roomheadings(a,null,null,c);for(var i=null,j=null,k=null,l=1;l<=d;l++)i=TOOL.empty(i)?e:j+g,j=i+f,k=TOOL.form_startfinish(Math.floor(i/60),i%60,Math.floor(j/60),j%60),h+=TOOL.html_slot(a,k,f);return h+=HTML.endtag("tbody")},TOOL.html_roomheadings_toprow=function(){return HTML.starttag("tr")+HTML.tag("td","")+TOOL.boldcenter("td",TOOL.str.room)+TOOL.boldcenter("td",TOOL.str.roomtopic)+HTML.endtag("tr")},TOOL.html_roomheadings_datarow=function(a,b){var c=TOOL.extract_sessionroom(a);return HTML.starttag("tr")+HTML.tag("th",b)+HTML.tag("td",TOOL.rooms("room_"+b,c.name))+HTML.tag("td",HTML.text("topic_"+b,c.topic))+HTML.endtag("tr")},TOOL.html_roomheadings_lastrow=function(){var a={};return a[TOOL.APPLY_CURRENT]=TOOL.str.currentheadings,a[TOOL.APPLY_THISDAY]=TOOL.str.allheadingsthisday,a[TOOL.APPLY_ALLDAYS]=TOOL.str.allheadingsalldays,HTML.starttag("tr")+HTML.tag("th",TOOL.str.applyto)+HTML.tag("td",HTML.select("applyto",a,TOOL.APPLY_CURRENT,{}))+HTML.endtag("tr")},TOOL.html_roomheading=function(a,b,c,d){return HTML.starttag("th",{"class":"roomheading room"+a})+HTML.tag("span",b,{"class":"roomname"})+HTML.tag("span",c,{"class":"roomseats"})+HTML.tag("div",d,{"class":"roomtopic"})+HTML.endtag("th")},TOOL.html_roomheadings=function(a,b,c,d){TOOL.empty(d)&&(d=TOOL.extract_roomcount(a));var e="";e+=HTML.starttag("tr",{"class":"roomheadings"}),e+=HTML.tag("th","",{"class":"timeheading"});for(var f=1;f<=d;f++){if(TOOL.empty(b)||TOOL.empty(b[f])||"0"==b[f])var g=TOOL.str.roomname+" ("+f+")",h=40,i=TOOL.str.roomtopic+" ("+f+")";else var g=TOOL.extract_roomname_txt(b[f]),h=TOOL.extract_roomseats_txt(b[f]),i=TOOL.trim(c[f]);e+=TOOL.html_roomheading(f,g,h,i)}return e+=HTML.endtag("tr")},TOOL.html_timeroom=function(a,b,c,d){return TOOL.html_time(a,b)+TOOL.html_room(a,c,d)},TOOL.html_time=function(a,b){var c=TOOL.extract_startfinish_html(a,b),d=TOOL.extract_duration_html(a,b),e=HTML.tag("span",c,{"class":"startfinish"})+HTML.tag("span",d,{"class":"duration"});return HTML.tag("div",e,{"class":"time"})},TOOL.html_room=function(a,b,c){if("0"==c)return"";if(TOOL.empty(c))var d=TOOL.extract_roomname_html(a,b),e=TOOL.extract_roomseats_html(a,b),f=TOOL.extract_roomtopic_html(a,b);else var d=TOOL.extract_roomname_txt(c),e=TOOL.extract_roomseats_txt(c),f="";var g=HTML.tag("span",d,{"class":"roomname"})+HTML.tag("span",e,{"class":"roomseats"})+HTML.tag("div",f,{"class":"roomtopic"});return HTML.tag("div",g,{"class":"room"})},TOOL.html_item=function(a,b){TOOL.empty(b)&&(b="session");var c={"class":b};return a&&(c.id=a),HTML.tag("div","",c)},TOOL.html_sessions=function(a,b){for(var c="",d=a;d<=b;d++)c+=HTML.tag("td","",{"class":"session emptysession"});return c},TOOL.html_slot=function(a,b,c){var d="",e=TOOL.get_string("durationtxt",c);return d+=HTML.starttag("tr",{"class":"slot duration"+c}),d+=HTML.starttag("td",{"class":"timeheading"}),d+=HTML.tag("span",b,{"class":"startfinish"}),d+=HTML.tag("span",e,{"class":"duration"}),d+=HTML.endtag("td"),d+=TOOL.html_sessions(1,TOOL.extract_roomcount(a)),d+=HTML.endtag("tr")},TOOL.get_string=function(a,b){if(TOOL.empty(a)||TOOL.empty(TOOL.str[a]))return"";var c=TOOL.str[a];if(b||0===b)if("string"==typeof b||"number"==typeof b){var d=new RegExp("\\{\\$a\\}","g");c=TOOL.str[a].replace(d,b)}else for(var e in b){var d=new RegExp("\\{\\$a->"+e+"\\}","g");c=c.replace(d,b[e])}return c},TOOL.hours=function(a,b,c,d,e){var f=TOOL.empty(c)&&TOOL.empty(d);TOOL.empty(c)&&(c=0),TOOL.empty(d)&&(d=23),TOOL.empty(e)&&(e={}),TOOL.empty(e["class"])&&(e["class"]="select"+a);for(var g={},h=c;h<=d;h++)f?g[h]=TOOL.pad(h):g[h]=TOOL.get_string("numhours",h);return HTML.select(a,g,b,e)},TOOL.mins=function(a,b,c,d,e){var f=TOOL.empty(c)&&TOOL.empty(d);TOOL.empty(c)&&(c=0),TOOL.empty(d)&&(d=59),TOOL.empty(e)&&(e={}),TOOL.empty(e["class"])&&(e["class"]="select"+a);for(var g={},h=c;h<=d;h+=5)f?g[h]=TOOL.pad(h):g[h]=TOOL.get_string("nummins",h);return HTML.select(a,g,b,e)},TOOL.hoursmins=function(a,b,c){var b=TOOL.hours(a+"hours",b),c=TOOL.mins(a+"mins",c);return b+" : "+c},TOOL.range=function(a,b,c,d,e){if(TOOL.empty(a))return"";TOOL.empty(c)&&(c=1),TOOL.empty(d)&&(d=10),TOOL.empty(b)&&(b=d),TOOL.empty(e)&&(e={}),e["class"]&&(e["class"]="select"+a);for(var f={},g=c;g<=d;g++)f[g]=g;return HTML.select(a,f,b,e)},TOOL.position=function(a,b,c,d){a&&(a=TOOL.get_string(a).toLowerCase()),TOOL.empty(c)&&(c="position"),TOOL.empty(d)&&(d={});for(var e={},f=1;f<=b;f++)if(TOOL.empty(a))e[f]=f;else{var g={type:a,num:f};e[f]=TOOL.get_string("positionbefore",g)}return e[f]=TOOL.str.positionlast,HTML.select(c,e,f,d)},TOOL.days_select=function(a){var b=TOOL.extract_active_day(),c=TOOL.extract_main_language(),d={};return $(".tab").each(function(){var a=TOOL.extract_day($(this).prop("class")),b=$(this).find("span.multilang[lang="+c+"]");b=b.length?b.html():$(this).html(),d[a]=TOOL.force_single_line(b)}),HTML.select(a,d,b,{})},TOOL.days_checkbox=function(a){var b="",c=TOOL.str.day,d=TOOL.extract_active_day();return $(".day").each(function(){var e=TOOL.extract_parent_day(this),f=a+"_"+e,g=TOOL.extract_parent_daytext(this);g=HTML.tag("label",g,{"for":"id_"+f}),g=HTML.checkbox(f,e==d)+" "+g,b+=HTML.starttag("tr",{valign:"top"})+HTML.tag("th",c)+HTML.tag("td",g,{colspan:"2"})+HTML.endtag("tr"),c=""}),b},TOOL.days=function(a,b,c){return TOOL.clone_menu("schedule_day",a,b,c)},TOOL.rooms=function(a,b,c){return TOOL.clone_menu("schedule_roomname",a,b,c)},TOOL.categories=function(a,b,c){return TOOL.clone_menu("presentation_category",a,b,c)},TOOL.types=function(a,b,c){return TOOL.clone_menu("presentation_type",a,b,c)},TOOL.topics=function(a,b,c){return TOOL.clone_menu("presentation_topic",a,b,c)},TOOL.clone_menu=function(a,b,c,d){var e=$("select[name="+a+"]");return 0==e.length?"":(e=e.first().clone(),TOOL.dialog_menu(e,b,c,d))},TOOL.times=function(a,b,c){return TOOL.generate_menu("times",a,b,c)},TOOL.keywords=function(a,b,c){return TOOL.generate_menu("keywords",a,b,c)},TOOL.generate_menu=function(a,b,c,d){var e=0,f={};if($("#items .scheduleinfo ."+a+" .text").each(function(){var a=$(this).text();f[a]?f[a]++:f[a]=1,e++}),0==e)return"";var g=[];for(var h in f)g.push([h,f[h]]);g.sort(function(a,b){return a[1]<b[1]?1:a[1]>b[1]?-1:a[0]<b[0]?-1:a[0]>b[0]?1:0});for(var e=0;e<g.length;e++){var h=g[e][0]+" ("+g[e][1]+")";g[e]=HTML.tag("option",h,{value:h})}return g=$(HTML.tag("select",g.join(""))),TOOL.dialog_menu(g,b,c,d)},TOOL.dialog_menu=function(a,b,c,d){a.prop("name",b),a.prop("id","id_"+b);var e=new RegExp("\\([^()]*\\)$");if(a.find("option").each(function(){var a=TOOL.trim($(this).val().replace(e,""));"0"===a&&(a=""),this.setAttribute("value",a)}),c){c=c.replace(new RegExp(' style="[^"]*"',"g"),""),c=c.replace(new RegExp("[\\r\\n]+","g"),""),c=TOOL.trim(c);var f=!1;a.find("option").each(function(){var a=$(this).val();window.console.log("v="+a+", value="+c),0!=f||!a||0!=a.indexOf(c)&&0!=c.indexOf(a)?(this.selected=!1,this.removeAttribute("selected")):(f=!0,this.selected=!0,this.setAttribute("selected","selected"))})}if(d){if(d.size){var g=a.find("option:not(:empty)").length;g=Math.min(g,d.size),g<=1?(delete d.size,delete d.multiple):(d.size=g,d.multiple="multiple",a.find("option:empty").remove())}for(var h in d)a.prop(h,d[h])}var i=0;return a.find("option").each(function(){var a=$(this).text();$(this).prop("title",a),$(this).text(UNICODE.shorten(a)),a&&i++}),0==i?"":a.prop("outerHTML")},TOOL.boldcenter=function(a,b){var c={align:"center"};return HTML.tag("td",HTML.tag("b",b),c)},TOOL.multilang=function(a,b){var c={"class":"multilang",lang:b};return HTML.tag("span",a,c)},TOOL.multilangs=function(a,b){var c=TOOL.form_multilang_values(a,b),d="",e=[];for(var f in c)d=c[f],e.push(TOOL.multilang(d,f));return e.length<2?d:e.join("")},TOOL.force_simple_html=function(a){var b="br|hr|b|i|u|em|strong|big|small|sup|sub|tt|var";return a.replace(new RegExp("<(/?\\w+)\\b[^>]*>","g"),"<$1>").replace(new RegExp("</([^>]*)>","g"),"<$1/>").replace(new RegExp("<(?!"+b+")[^>]*>","g"),"").replace(new RegExp("<([^>]*)/>","g"),"</$1>")},TOOL.force_single_line=function(a){var b=new RegExp("<br\\b[^>]*>","g");return TOOL.trim(a.replace(b," "))},TOOL.pad=function(a,b,c,d){if(TOOL.empty(a))return"";for(a+="",TOOL.empty(b)&&(b=2),TOOL.empty(c)&&(c=isNaN(a)?" ":"0"),TOOL.empty(d)&&(d=!isNaN(a));a.length<b;)d?a=c+a:a+=c;return a},TOOL.trim=function(a){if(TOOL.empty(a))return"";a+="";var b=new RegExp("\\s+","g"),c=new RegExp("(^\\s+)|(\\s+$)","g");return a.replace(c,"").replace(b," ")},TOOL.form_startfinish=function(a,b,c,d){return TOOL.pad(a)+TOOL.str.labelsep+TOOL.pad(b)+TOOL.str.durationseparator+TOOL.pad(c)+TOOL.str.labelsep+TOOL.pad(d)},TOOL.form_duration=function(a,b,c,d){var e=0;return c<a&&(e=23),c==a&&d<=b&&(e=23),e=60*(e+c-a),e=TOOL.pad(e+d-b)},TOOL.form_value=function(a,b,c){var d=$(a).find("[name="+b+"]");if(d.length)switch(!0){case d.is("select"):d=d.find("option:selected");break;case d.is("input[type=radio]"):d=d.find("input:checked");break;case d.is("input[type=checkbox]"):d=d.is(":checked")?d:""}if(0==d.length)return c?0:"";if(1==d.length)return d=d.val(),c?parseInt(d):d;for(var e=[],f=0;f<d.length;f++)e.push(c?parseInt(d[f].value):d[f].value);return e},TOOL.form_values=function(a,b,c){var d=[];return $(a).find("[name^="+b+"]").each(function(){var e=$(this).prop("name");if(e==b)d=TOOL.form_value(a,b,c);else{var f=parseInt(e.substr(b.length));d[f]=TOOL.form_value(a,e,c)}}),d},TOOL.form_multilang_values=function(a,b){var c,d,e={};return $(a).find("input[name^="+b+"]").each(function(){c=$(this).prop("name").substr(b.length+1),d=d=TOOL.trim($(this).val()),d&&(e[c]=TOOL.force_simple_html(d))}),e},TOOL.empty=function(a){return void 0===a||null===a},TOOL});